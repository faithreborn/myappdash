name: Build iOS App

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build web app
        run: npm run build

      - name: Setup Capacitor iOS
        run: |
          npx cap add ios || true
          npx cap sync ios

      - name: Generate App Icons
        run: |
          # Install ImageMagick for icon generation
          brew install imagemagick
          
          # Create icon sizes for iOS
          ICON_DIR="ios/App/App/Assets.xcassets/AppIcon.appiconset"
          mkdir -p "$ICON_DIR"
          
          if [ -f "public/icon.png" ]; then
            # Generate all required iOS icon sizes
            convert public/icon.png -resize 20x20 "$ICON_DIR/AppIcon-20x20@1x.png"
            convert public/icon.png -resize 40x40 "$ICON_DIR/AppIcon-20x20@2x.png"
            convert public/icon.png -resize 60x60 "$ICON_DIR/AppIcon-20x20@3x.png"
            convert public/icon.png -resize 29x29 "$ICON_DIR/AppIcon-29x29@1x.png"
            convert public/icon.png -resize 58x58 "$ICON_DIR/AppIcon-29x29@2x.png"
            convert public/icon.png -resize 87x87 "$ICON_DIR/AppIcon-29x29@3x.png"
            convert public/icon.png -resize 40x40 "$ICON_DIR/AppIcon-40x40@1x.png"
            convert public/icon.png -resize 80x80 "$ICON_DIR/AppIcon-40x40@2x.png"
            convert public/icon.png -resize 120x120 "$ICON_DIR/AppIcon-40x40@3x.png"
            convert public/icon.png -resize 120x120 "$ICON_DIR/AppIcon-60x60@2x.png"
            convert public/icon.png -resize 180x180 "$ICON_DIR/AppIcon-60x60@3x.png"
            convert public/icon.png -resize 76x76 "$ICON_DIR/AppIcon-76x76@1x.png"
            convert public/icon.png -resize 152x152 "$ICON_DIR/AppIcon-76x76@2x.png"
            convert public/icon.png -resize 167x167 "$ICON_DIR/AppIcon-83.5x83.5@2x.png"
            convert public/icon.png -resize 1024x1024 "$ICON_DIR/AppIcon-1024x1024@1x.png"
            echo "✅ Icons generated from public/icon.png"
          else
            echo "⚠️ public/icon.png not found, using default icons"
          fi

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install CocoaPods
        run: |
          cd ios/App
          pod install

      - name: Build iOS App (Simulator)
        run: |
          cd ios/App
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            -derivedDataPath build \
            ONLY_ACTIVE_ARCH=YES \
            DEBUG_INFORMATION_FORMAT=dwarf \
            build

      - name: Prepare App for Upload
        run: |
          # Find and copy only the .app bundle
          mkdir -p upload
          cp -r ios/App/build/Build/Products/Release-iphonesimulator/App.app upload/
          # Compress it
          cd upload
          zip -r FaciStoreAdmin.zip App.app

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: upload/FaciStoreAdmin.zip
          retention-days: 30
